#!/bin/sh

set -e

# Ensure Features Are Selected
if [ -z "${MCPI_SUBSHELL}" ]; then
    MCPI_FEATURES="$(zenity --class minecraft-pi --list --checklist --column 'Enabled' --column 'Feature' FALSE 'Touch GUI' FALSE 'Survival Mode' FALSE 'Fix Bow & Arrow' FALSE 'Fix Attacking' FALSE 'Mob Spawning' FALSE 'Fancy Graphics' FALSE 'Disable Autojump By Default' FALSE 'Fix Sign Placement')"
    MCPI_USERNAME="$(zenity --class minecraft-pi --entry --text 'Minecraft Username:' --entry-text 'StevePi')"
fi
export MCPI_FEATURES
export MCPI_USERNAME

# Start VirGL
virgl_test_server &
VIRGL_PID="$!"

# Ensure Groups Are Correct
if [ -z "${MCPI_SUBSHELL}" ]; then
    if ! id -Gn "$(whoami)" | grep '\bdocker\b' > /dev/null; then
        pkexec adduser "$(whoami)" docker
    fi
    exec sg docker "env MCPI_SUBSHELL=1 \"$(realpath -e "$0")\""
fi

# Allow X11 Connections From Root
xhost local:root

# Launch Minecraft
DOCKER_COMPOSE="docker-compose -f /usr/share/minecraft-pi/docker-compose.yml"
${DOCKER_COMPOSE} up
${DOCKER_COMPOSE} down

# Kill VirGL
kill "${VIRGL_PID}"
